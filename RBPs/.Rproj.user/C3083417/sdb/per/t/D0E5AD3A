{
    "collab_server" : "",
    "contents" : "\n#!/usr/bin/env Rscript\n\nlibrary(DescTools)\nlibrary(stringr)\nlibrary(ggplot2)\nlibrary(data.table)\nlibrary(readr)\nlibrary(Hmisc)\nlibrary(cowplot)\n\n\n\nread_dist_table <- function(path){\n  \n  dist_table <- data.table(read_delim(path, \n                                      \"\\t\", escape_double = FALSE, col_names = FALSE, \n                                      trim_ws = TRUE))\n  \n  dist_table <- dist_table[, 2:2001]\n  dist_table <- data.table(as.data.frame(t(dist_table)))\n  colnames(dist_table) <- c(\"Position\", \"Occurrences\")\n  \n  dist_table[,median:=median(Occurrences)]\n  dist_table[, Enrrichment:=Occurrences/median]\n  dist_table[, Position:=Position-1]\n  \n  return(dist_table)  \n}\n\n\n\nplot_density_binomial_RBP <- function(up_plus, up_minus, down_plus, down_minus, observations_up, observations_down, sig){\n  \n  \n  up_TOTAL <-  merge(up_plus, up_minus, by=\"Position\")\n  up_TOTAL[,Occurrences:=Occurrences.x+Occurrences.y]\n  up_TOTAL[,Occurrences:=Occurrences.x+Occurrences.y]\n  \n  \n  \n  \n  up_TOTAL <- cbind(up_TOTAL, up_TOTAL[, binconf(Occurrences, observations_up, alpha=sig) ])\n  \n  up_TOTAL[,median:=median(PointEst)]\n  up_TOTAL[, Enrrichment:=PointEst/median]\n  up_TOTAL[, Enrrichment_l:=Lower/median]\n  up_TOTAL[, Enrrichment_u:=Upper/median]\n  up_TOTAL[, Position:=Position-1]\n  \n  \n  \n  down_TOTAL <-  merge(down_plus, down_minus, by=\"Position\")\n  down_TOTAL[,Occurrences:=Occurrences.x+Occurrences.y]\n  \n  \n  down_TOTAL <- cbind(down_TOTAL, down_TOTAL[, binconf(Occurrences, observations_down, alpha=sig) ])\n  \n  down_TOTAL[,median:=median(PointEst)]\n  down_TOTAL[, Enrrichment:=PointEst/median]\n  down_TOTAL[, Enrrichment_l:=Lower/median]\n  down_TOTAL[, Enrrichment_u:=Upper/median]\n  down_TOTAL[, Position:=Position-1]  \n  \n  \n  up_TOTAL[ ,exon_pos:=\"Upstream\"]\n  down_TOTAL[ ,exon_pos:=\"Downstream\"]\n  \n  TOTAL <- rbind(up_TOTAL, down_TOTAL)\n  \n  TOTAL$exon_pos <-  factor(TOTAL$exon_pos, levels=c(\"Upstream\", \"Downstream\" )) \n  \n  p <- ggplot(TOTAL)+\n    geom_line(aes(x=Position,y=Enrrichment)) +\n    geom_ribbon(aes(ymin=Enrrichment_l, ymax=Enrrichment_u, x=Position), alpha=0.3 )+\n    facet_grid( . ~ exon_pos ) +\n    theme_bw()\n  \n  #show(p)\n  \n  return(TOTAL) \n  \n}\n\n\nplot_eql_diff_binomial_table <- function(eql_up_plus, eql_up_minus, eql_down_plus, eql_down_minus, diff_up_plus, diff_up_minus, diff_down_plus, diff_down_minus, TOTAL.eql_up, TOTAL.eql_down, TOTAL.diff_up, TOTAL.diff_down, sig   ){ \n  \n  \n  diff.up_plus <- read_dist_table(diff_up_plus)\n  diff.up_minus <- read_dist_table(diff_up_minus)\n  diff.down_plus <- read_dist_table(diff_down_plus)\n  diff.down_minus <- read_dist_table(diff_down_minus)\n  diff.up_minus[,Position:=Position*-1]\n  diff.down_minus[,Position:=Position*-1]\n  \n  \n  diff.TOTAL <- plot_density_binomial_RBP(diff.up_plus, diff.up_minus, diff.down_plus, diff.down_minus, TOTAL.diff_up, TOTAL.diff_down, sig)\n  \n  \n  eql.up_plus <- read_dist_table(eql_up_plus)\n  eql.up_minus <- read_dist_table(eql_up_minus)\n  eql.down_plus <- read_dist_table(eql_down_plus)\n  eql.down_minus <- read_dist_table(eql_down_minus)\n  eql.up_minus[,Position:=Position*-1]\n  eql.down_minus[,Position:=Position*-1]\n  \n  \n  eql.TOTAL <- plot_density_binomial_RBP(eql.up_plus, eql.up_minus, eql.down_plus, eql.down_minus, TOTAL.eql_up, TOTAL.eql_down, sig)\n  \n  diff.TOTAL[, type:=\"wG4\"]\n  eql.TOTAL[, type:=\"woG4\"]\n  \n  diff_eql.TOTAL <- rbind(diff.TOTAL, eql.TOTAL)\n  \n  return(diff_eql.TOTAL)\n  \n}\n\n\n\nfiles <- list.files(\"./scores/\", pattern =\"exon.down_minus.bed.filtered.100bp_intron.intersect_wao.All_G4.tsv.clean_minus_strand.wG4.score.*.num\")\n\nsamples <- str_replace(str_replace(files,  \"exon.down_minus.bed.filtered.100bp_intron.intersect_wao.All_G4.tsv.clean_minus_strand.wG4.score.\", \"\" ), \".bed.list.out.num\", \"\")\n\nmetadata <- fread(\"./metadata.tsv\")\n\n\nfor (sample in samples){\n  \n  print(sample)\n  \n  if ( (length( list.files(\"./scores/\", pattern = sample))==192 ) & (metadata[`File accession`==sample, Assembly]==\"hg19\" ) ) {\n    \n    RBP_binomial_table_non_template <- plot_eql_diff_binomial_table(\n      paste(\"./scores/exon.up_plus.bed.filtered.100bp_intron.intersect_wao.All_G4.tsv.clean_plus_strand.woG4.score.\", sample, \".bed.list.out.num\", sep=\"\"),\n      paste(\"./scores/exon.up_minus.bed.filtered.100bp_intron.intersect_wao.All_G4.tsv.clean_minus_strand.woG4.score.\", sample, \".bed.list.out.num\", sep=\"\"),\n      paste(\"./scores/exon.down_plus.bed.filtered.100bp_intron.intersect_wao.All_G4.tsv.clean_plus_strand.woG4.score.\", sample, \".bed.list.out.num\", sep=\"\"),\n      paste(\"./scores/exon.down_minus.bed.filtered.100bp_intron.intersect_wao.All_G4.tsv.clean_minus_strand.woG4.score.\", sample, \".bed.list.out.num\", sep=\"\"),\n      paste(\"./scores/exon.up_plus.bed.filtered.100bp_intron.intersect_wao.All_G4.tsv.clean_plus_strand.wG4.score.\", sample, \".bed.list.out.num\", sep=\"\"),\n      paste(\"./scores/exon.up_minus.bed.filtered.100bp_intron.intersect_wao.All_G4.tsv.clean_minus_strand.wG4.score.\", sample, \".bed.list.out.num\", sep=\"\"),\n      paste(\"./scores/exon.down_plus.bed.filtered.100bp_intron.intersect_wao.All_G4.tsv.clean_plus_strand.wG4.score.\", sample, \".bed.list.out.num\", sep=\"\"),\n      paste(\"./scores/exon.down_minus.bed.filtered.100bp_intron.intersect_wao.All_G4.tsv.clean_minus_strand.wG4.score.\", sample, \".bed.list.out.num\", sep=\"\"),\n      110870 + 109467,\n      108638 + 107433,\n      3587 + 3431,\n      5819 + 5465,\n      0.05\n    )\n    \n    RBP_binomial_table_non_template$pos_int <- cut(RBP_binomial_table_non_template$Position, breaks = 40, labels = seq(-999,1000,50)-1)\n    RBP_binomial_table_non_template_stats <- RBP_binomial_table_non_template[ , .(Enrrichment=mean(Enrrichment), Enrrichment_l=mean(Enrrichment_l), Enrrichment_u=mean(Enrrichment_u))  , by=c( \"exon_pos\", \"type\",  \"pos_int\"  ) ]\n    \n    \n    Total.Overlaps.non_template <- c()\n    \n    for (i in seq(-200, 200, 50)){\n      \n      O.Upstream <- Overlap(\n        RBP_binomial_table_non_template_stats[ exon_pos==\"Upstream\" & pos_int==i & type==\"wG4\", c(\"Enrrichment_l\", \"Enrrichment_u\")],\n        RBP_binomial_table_non_template_stats[ exon_pos==\"Upstream\" & pos_int==i & type==\"woG4\", c(\"Enrrichment_l\", \"Enrrichment_u\")]\n      )\n      \n      O.Downstream <- Overlap(\n        RBP_binomial_table_non_template_stats[ exon_pos==\"Downstream\" & pos_int==i & type==\"wG4\", c(\"Enrrichment_l\", \"Enrrichment_u\")],\n        RBP_binomial_table_non_template_stats[ exon_pos==\"Downstream\" & pos_int==i & type==\"woG4\", c(\"Enrrichment_l\", \"Enrrichment_u\")]\n      )\n      \n      Total.Overlaps.non_template <- rbind(Total.Overlaps.non_template, c(O.Upstream, O.Downstream))\n      \n    }\n    \n    \n    RBP_binomial_table_template <- plot_eql_diff_binomial_table(\n      paste(\"./scores/exon.up_plus.bed.filtered.100bp_intron.intersect_wao.All_G4.tsv.clean_minus_strand.woG4.score.\", sample, \".bed.list.out.num\", sep=\"\"),\n      paste(\"./scores/exon.up_minus.bed.filtered.100bp_intron.intersect_wao.All_G4.tsv.clean_plus_strand.woG4.score.\", sample, \".bed.list.out.num\", sep=\"\"),\n      paste(\"./scores/exon.down_plus.bed.filtered.100bp_intron.intersect_wao.All_G4.tsv.clean_minus_strand.woG4.score.\", sample, \".bed.list.out.num\", sep=\"\"),\n      paste(\"./scores/exon.down_minus.bed.filtered.100bp_intron.intersect_wao.All_G4.tsv.clean_plus_strand.woG4.score.\", sample, \".bed.list.out.num\", sep=\"\"),\n      paste(\"./scores/exon.up_plus.bed.filtered.100bp_intron.intersect_wao.All_G4.tsv.clean_minus_strand.wG4.score.\", sample, \".bed.list.out.num\", sep=\"\"),\n      paste(\"./scores/exon.up_minus.bed.filtered.100bp_intron.intersect_wao.All_G4.tsv.clean_plus_strand.wG4.score.\", sample, \".bed.list.out.num\", sep=\"\"),\n      paste(\"./scores/exon.down_plus.bed.filtered.100bp_intron.intersect_wao.All_G4.tsv.clean_minus_strand.wG4.score.\", sample, \".bed.list.out.num\", sep=\"\"),\n      paste(\"./scores/exon.down_minus.bed.filtered.100bp_intron.intersect_wao.All_G4.tsv.clean_plus_strand.wG4.score.\", sample, \".bed.list.out.num\", sep=\"\"),\n      110841 + 109504,\n      111508 + 110025,\n      3616 + 3394,\n      2949 + 2873,\n      0.05\n    )\n    \n    \n    RBP_binomial_table_template$pos_int <- cut(RBP_binomial_table_template$Position, breaks = 40, labels = seq(-999,1000,50)-1)\n    RBP_binomial_table_template_stats <- RBP_binomial_table_template[ , .(Enrrichment=mean(Enrrichment), Enrrichment_l=mean(Enrrichment_l), Enrrichment_u=mean(Enrrichment_u))  , by=c( \"exon_pos\", \"type\",  \"pos_int\"  ) ]\n    \n    \n    Total.Overlaps.template <- c()\n    \n    for (i in seq(-200, 200, 50)){\n      \n      O.Upstream <- Overlap(\n        RBP_binomial_table_template_stats[ exon_pos==\"Upstream\" & pos_int==i & type==\"wG4\", c(\"Enrrichment_l\", \"Enrrichment_u\")],\n        RBP_binomial_table_template_stats[ exon_pos==\"Upstream\" & pos_int==i & type==\"woG4\", c(\"Enrrichment_l\", \"Enrrichment_u\")]\n      )\n      \n      O.Downstream <- Overlap(\n        RBP_binomial_table_template_stats[ exon_pos==\"Downstream\" & pos_int==i & type==\"wG4\", c(\"Enrrichment_l\", \"Enrrichment_u\")],\n        RBP_binomial_table_template_stats[ exon_pos==\"Downstream\" & pos_int==i & type==\"woG4\", c(\"Enrrichment_l\", \"Enrrichment_u\")]\n      )\n      \n      Total.Overlaps.template <- rbind(Total.Overlaps.template, c(O.Upstream, O.Downstream))\n      \n    }\n    \n    \n    \n    \n    if (0 %in% rbind(Total.Overlaps.non_template,  Total.Overlaps.template) ){\n      \n      \n      protein = metadata[`File accession`==sample, `Experiment target` ]\n      cell_line = metadata[`File accession`==sample, `Biosample term name`]\n      \n      \n      RBP_plot.non_template <- ggplot(RBP_binomial_table_non_template) +\n        geom_line(aes(x=Position, y=Enrrichment, color=type)) +\n        geom_ribbon(aes(ymin=Enrrichment_l, ymax=Enrrichment_u, x=Position, fill=type), alpha=0.3 )+\n        xlim(c(-250,250)) +\n        facet_grid(. ~ exon_pos  ) +\n        labs(colour = \"100nt flanking intronic window\", fill=\"100nt flanking intronic window\") +\n        theme_bw() +\n        ggtitle(paste(protein, cell_line, sample, \"non-template\" )) +\n        theme(legend.position = \"top\", legend.direction = \"horizontal\") +\n        scale_fill_manual(values=c(\"#669900\", \"grey\")) +  \n        scale_color_manual(values=c(\"#669900\", \"darkgrey\"))\n      \n      \n      \n      \n      RBP_plot.template <-  ggplot(RBP_binomial_table_template) +\n        geom_line(aes(x=Position, y=Enrrichment, color=type)) +\n        geom_ribbon(aes(ymin=Enrrichment_l, ymax=Enrrichment_u, x=Position, fill=type), alpha=0.3 )+\n        xlim(c(-250,250)) +\n        facet_grid(. ~ exon_pos  ) +\n        labs(colour = \"100nt flanking intronic window\", fill=\"100nt flanking intronic window\") +\n        theme_bw() +\n        ggtitle(paste(protein, cell_line,  sample, \"template\")) +\n        theme(legend.position = \"top\", legend.direction = \"horizontal\") +\n        scale_fill_manual(values=c(\"#669900\", \"grey\")) +  \n        scale_color_manual(values=c(\"#669900\", \"darkgrey\"))\n      \n      \n      out_name = paste(protein, cell_line, sample, sep=\"_\")\n      \n      while (!is.null(dev.list()))  dev.off()\n      pdf(paste0(\"./plots/\", out_name , \".pdf\"), width = 10, height = 5) \n      print(plot_grid(RBP_plot.non_template, RBP_plot.template,  nrow =1))\n      dev.off() \n      \n    }\n    \n  }\n  \n  \n}\n",
    "created" : 1574724000969.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3207321824",
    "id" : "D0E5AD3A",
    "lastKnownWriteTime" : 1574867453,
    "last_content_update" : 1574867453128,
    "path" : "~/Google_Drive/Results/Non_B/Plot_RBPs_farm.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}